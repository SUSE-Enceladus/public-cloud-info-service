<html>
<head>
  <meta charset="utf-8"/>
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/jsviews.min.js"></script>
  <script src="assets/js/jsrender.min.js"></script>
  <script src="assets/js/jquery.dataTables.min.js"></script>
  <script src="assets/js/pluralize.js"></script>
  <link rel="stylesheet" href="./assets/css/jquery.dataTables.min.css"/>
  </head>
<body>
  <select id="csp" class='cloudProvider'></select>
  <div id="result">
  </div>
  <style>
    .cloudProvider {
	float: left;
	margin-right: .5%;
    }
    </style>
  <script id="theTmpl" type="text/x-jsrender">
  <select id="state">
    <option value="" default>All states</option>
    {{for states sort=true}}
      <option value="{{:}}">{{:}}</option>
    {{/for}}
  </select>

  {{if regions.length > 0}} <!-- some CSP may have not regions -->
    <select id= "region">
      <option value="" default>All {{:regionName}}</option>
    {{for regions sort=true}}
      <option value="{{:}}">{{:}}</option>
    {{/for}}
    </select>
  {{/if}}

  <table id="coolTable" class="display">
    <thead>
    {{for attributes}}
      <th>{{:}}</th>
    {{/for}}
    </thead>
    <tbody>
    {{for images ~attributes=attributes}}
      <tr class="odd">
      {{for ~attributes ~imgData=#data}}
        <td>{{:~imgData[#data]}}</td>
      {{/for}}
      </tr>
    {{/for}}
    </tbody>
  </table>
  </script>

  <script>
  var images = [];
  var attributes = {};
  var regions = {};
  var states = {};

  var regionIdx = {};
  var stateIdx = {};
  var cspFiles= '';

  jQuery.fn.dataTableExt.afnFiltering.push(
    function( oSettings, aData, iDataIdx ) {
      var state = $('#state').val();
      var region = $('#region').val();
      var current_csp = $('#csp').val();

      var result = true;

      if (region) result = result && aData[regionIdx] == region;
      if (state) result = result && aData[stateIdx] == state;

      return result;
    }
  );

    var csps = {aws: '/amazon.xml', azure: '/microsoft.xml', gcp: '/google.xml'}
    var cspsNames = [{aws: 'Amazon'}, {azure: 'Microsoft'}, {gcp: 'Google'}]

    var regionName = [];
    function set_values_csp(csp) {
      images = [];
      attributes = {};
      regions = {};
      states = {};
      regionIdx = {};
      stateIdx = {};

      $.get(csps[csp], function(xmlData) {
	var region = '';
	$(xmlData).find('image').each(function(idx, imgItem){
	  var image = {};
	  $(imgItem.attributes).each(function(idx, imgItem){
            image[imgItem.name] = imgItem.value;
            attributes[imgItem.name] = true;
            if (imgItem.name == 'region' || imgItem.name == 'environment') {
	      regions[imgItem.value] = true;
	      region = imgItem.name;
	    }

            if (imgItem.name == 'state') states[imgItem.value] = true;
	  });
	  images.push(image);
	});

	var attrKeys = Object.keys(attributes);

	regionIdx = attrKeys.indexOf(region);
	stateIdx = attrKeys.indexOf('state');

	var template = $.templates("#theTmpl");
	template.link(
	  "#result", {
            'attributes': Object.keys(attributes),
            'regions': Object.keys(regions),
            'states': Object.keys(states),
            'images': images,
	    'regionName': pluralize(region)
	  });

	var dataTable = $('#coolTable').DataTable();
	$('#state, #region').change(function() {
	  dataTable.draw();
	});
      });
    }
    $(document).ready(function() {
      var defaultCsp = 'azure';
      $.each(csps, function(i, option) {
	var name = option.substr(1, option.indexOf('.') - 1);
	name = name[0].toUpperCase() + name.slice(1);

	var attrs = {value: i};
        if (i == defaultCsp) {
          attrs['selected'] = true;
        }

	var option = $('<option/>').attr(attrs).text(name);
	$('#csp').append(option);
      });


      $('#csp').change(function() {
	set_values_csp($(this).val());
      });

      set_values_csp(defaultCsp);
  });
  </script>
</body>
</html>
